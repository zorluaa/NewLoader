local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local FOV_RADIUS = 75 -- FOV size
local Target = nil

-- Create FOV circle using Drawing.new
local FOVCircle = Drawing.new("Circle")
FOVCircle.Radius = FOV_RADIUS
FOVCircle.Thickness = 2
FOVCircle.Color = Color3.fromRGB(255, 0, 0)
FOVCircle.Filled = false
FOVCircle.Visible = true

-- Function to check if a target is inside the FOV circle
local function isTargetInFOV(target)
    local screenPoint, onScreen = Camera:WorldToViewportPoint(target.Position)
    if onScreen then
        local distance = (Vector2.new(screenPoint.X, screenPoint.Y) - Vector2.new(Mouse.X, Mouse.Y)).Magnitude
        return distance <= FOV_RADIUS
    end
    return false
end

-- Get the closest enemy inside the FOV
local function getBestTarget()
    local closestDistance = math.huge
    local bestTarget = nil

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local head = player.Character.Head
            if isTargetInFOV(head) then
                local distance = (head.Position - LocalPlayer.Character.Head.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    bestTarget = head
                end
            end
        end
    end
    return bestTarget
end

-- Silent Aim for Guns
local function shootGun()
    Target = getBestTarget()
    if Target then
        local gunController = workspace:FindFirstChild(LocalPlayer.Name) and workspace[LocalPlayer.Name]:FindFirstChild("GunController")
        if gunController then
            gunController:FireServer(Target.Position)
        end
    end
end

-- Silent Aim for Knives
local function attackWithKnife()
    Target = getBestTarget()
    if Target then
        local knifeController = workspace:FindFirstChild(LocalPlayer.Name) and workspace[LocalPlayer.Name]:FindFirstChild("KnifeController")
        if knifeController then
            knifeController:FireServer(Target.Position)
        end
    end
end

-- Update FOV circle position
RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(Mouse.X, Mouse.Y)
end)

-- Bind to mouse inputs
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        shootGun()
        attackWithKnife()
    end
end)
